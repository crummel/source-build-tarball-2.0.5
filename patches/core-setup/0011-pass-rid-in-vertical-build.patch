From b920f5698761fbd910e347898d4f6f09cf7661e6 Mon Sep 17 00:00:00 2001
From: karajas <karajas@microsoft.com>
Date: Tue, 10 Oct 2017 17:30:37 -0400
Subject: [PATCH 1/1] pass rid in vertical build

---
 .../src/Microsoft.NETCore.App.depproj                |  6 ++++--
 src/sharedFramework/sharedFramework.proj             | 20 ++++++++++----------
 2 files changed, 14 insertions(+), 12 deletions(-)

diff --git a/src/pkg/projects/Microsoft.NETCore.App/src/Microsoft.NETCore.App.depproj b/src/pkg/projects/Microsoft.NETCore.App/src/Microsoft.NETCore.App.depproj
index 9dcf30f..6e7fd69 100644
--- a/src/pkg/projects/Microsoft.NETCore.App/src/Microsoft.NETCore.App.depproj
+++ b/src/pkg/projects/Microsoft.NETCore.App/src/Microsoft.NETCore.App.depproj
@@ -17,7 +17,7 @@
     <RidSpecificAssets Condition="'$(NuGetRuntimeIdentifier)' != ''">true</RidSpecificAssets>
     <IntermediateOutputPath>$(IntermediateOutputPath)$(NuGetRuntimeIdentifier)</IntermediateOutputPath>
     <RestoreOutputPath>$(IntermediateOutputPath)</RestoreOutputPath>
-    <AdditionalRestoreArgs>/p:HasRuntimePackages=false /p:IntermediateOutputPath=$(IntermediateOutputPath)</AdditionalRestoreArgs>
+    <AdditionalRestoreArgs>/p:HasRuntimePackages=false /p:IntermediateOutputPath=$(IntermediateOutputPath) /p:NugetRuntimeIdentifier=$(DistroRid)</AdditionalRestoreArgs>
     <CrossGenSymbolsOutputPath>$(PackageSymbolsBinDir)/$(MSBuildProjectName)</CrossGenSymbolsOutputPath>
   </PropertyGroup>
 
@@ -52,6 +52,7 @@
   <!-- get paths from packages that are needed for cross-gen and other includes,
        only relevant for runtime-specific builds -->
   <Target Name="GetPackagePaths" Condition="'$(NuGetRuntimeIdentifier)' != ''" DependsOnTargets="ResolveNuGetPackages">
+
     <ItemGroup  Condition="'$(NuGetRuntimeIdentifier)' != ''">
       <_runtimeCLR Include="@(ReferenceCopyLocalPaths)" Condition="'%(ReferenceCopyLocalPaths.FileName)%(ReferenceCopyLocalPaths.Extension)' == '$(LibraryFilePrefix)coreclr$(LibraryFileExtension)'" />
       <_runtimeCoreLib Include="@(ReferenceCopyLocalPaths)" Condition="'%(ReferenceCopyLocalPaths.FileName)%(ReferenceCopyLocalPaths.Extension)' == 'System.Private.CoreLib.dll'" />
@@ -94,11 +95,12 @@
     </ItemGroup>
 
     <Message Text="%(_requiredProperty.Identity): $(%(_requiredProperty.Identity))" />
+
     <Error Condition="'$(%(_requiredProperty.Identity))' == ''" Text="Required property %(_requiredProperty.Identity) was not set." />
     <Error Condition="!Exists('$(%(_requiredProperty.Identity))')" Text="Required property %(_requiredProperty.Identity) with value '$(%(_requiredProperty.Identity))' does not exist." />
   </Target>
 
-  <Target Name="GenerateHashVersionsFile" DependsOnTargets="GetPackagePaths;ResolveNuGetPackages">
+  <Target Name="GenerateHashVersionsFile" DependsOnTargets="GetPackagePaths;ResolveNugetPackages">
     <PropertyGroup>
       <CoreFxVersionFile
         Condition="$([System.String]::new('%(Reference.Identity)').ToLowerInvariant().Contains('system.runtime.dll'))">
diff --git a/src/sharedFramework/sharedFramework.proj b/src/sharedFramework/sharedFramework.proj
index d287053..94442cc 100644
--- a/src/sharedFramework/sharedFramework.proj
+++ b/src/sharedFramework/sharedFramework.proj
@@ -23,18 +23,18 @@
     
     <PropertyGroup>
       <SharedFrameworkSourceRoot>$(MSBuildThisFileDirectory)framework</SharedFrameworkSourceRoot>
-      <CommonSharedFrameworkArgs>/p:TargetFramework=$(Framework) /p:RuntimeIdentifier=$(PackageTargetRid) /p:RuntimeFrameworkVersion=$(SharedFrameworkNugetVersion)</CommonSharedFrameworkArgs>
+      <CommonSharedFrameworkArgs>/p:TargetFramework=$(Framework) /p:RuntimeIdentifier=$(DistroRid) /p:RuntimeFrameworkVersion=$(SharedFrameworkNugetVersion)</CommonSharedFrameworkArgs>
     </PropertyGroup>  
 
     <RemoveDir Directories="$(SharedFrameworkNameAndVersionRoot)" />
 
-    <Exec Command="$(DotnetRestoreCommand) --source $(PackagesOutDir) $(CommonSharedFrameworkArgs)"
+    <Exec Command="$(DotnetToolCommand) restore --packages $(SharedFrameworkIntermediatePackagesDir) --source $(PackagesOutDir) --source $(PackagesDir) $(CommonSharedFrameworkArgs)"
           WorkingDirectory="$(SharedFrameworkSourceRoot)" />
 
     <!-- We publish to a sub folder of the PublishRoot so tools like heat and zip can generate folder structures easier. -->
-    <Exec Command="$(DotnetToolCommand) publish --output $(SharedFrameworkNameAndVersionRoot) $(CommonSharedFrameworkArgs)"
+    <Exec Command="$(DotnetToolCommand) publish --output $(SharedFrameworkNameAndVersionRoot) $(CommonSharedFrameworkArgs) /p:PackagesDir=$(SharedFrameworkIntermediatePackagesDir)"
           WorkingDirectory="$(SharedFrameworkSourceRoot)"
-          EnvironmentVariables="NUGET_PACKAGES=$(PackagesDir)" />
+          EnvironmentVariables="NUGET_PACKAGES=$(SharedFrameworkIntermediatePackagesDir)" />
 
     <!-- Clean deps.json -->
     <ChangeEntryPointLibraryName DepsFile="$(SharedFrameworkNameAndVersionRoot)/framework.deps.json" />
@@ -133,18 +133,18 @@
   <Target Name="RestoreLockedCoreHost">
     <PropertyGroup>
       <LockedHostSourceRoot>$(MSBuildThisFileDirectory)lockedhost</LockedHostSourceRoot>
-      <CommonLockedHostArgs>/p:TargetFramework=$(Framework) /p:RuntimeIdentifier=$(PackageTargetRid) /p:HostResolverVersion=$(HostResolverVersion) /p:HostVersion=$(HostVersion)</CommonLockedHostArgs>
+      <CommonLockedHostArgs>/p:TargetFramework=$(Framework) /p:RuntimeIdentifier=$(DistroRid) /p:HostResolverVersion=$(HostResolverVersion) /p:HostVersion=$(HostVersion)</CommonLockedHostArgs>
+      <LockedCoreHostRestoreCommand>$(DotnetToolCommand) restore --packages $(SharedFrameworkIntermediatePackagesDir) --source $(PackagesOutDir) $(CommonLockedHostArgs)</LockedCoreHostRestoreCommand>
     </PropertyGroup>
 
     <RemoveDir Directories="$(CoreHostLockedDir)" />
 
-    <Exec Command="$(DotnetRestoreCommand) --source $(PackagesOutDir) $(CommonLockedHostArgs)"
-          WorkingDirectory="$(LockedHostSourceRoot)" />
+    <Exec Command="$(LockedCoreHostRestoreCommand)" WorkingDirectory="$(LockedHostSourceRoot)" />
 
 
-    <Exec Command="$(DotnetToolCommand) publish --output $(CoreHostLockedDir) $(CommonLockedHostArgs)"
+    <Exec Command="$(DotnetToolCommand) publish --output $(CoreHostLockedDir) $(CommonLockedHostArgs) /p:PackagesDir=$(SharedFrameworkIntermediatePackagesDir)"
           WorkingDirectory="$(LockedHostSourceRoot)"
-          EnvironmentVariables="NUGET_PACKAGES=$(PackagesDir)" />
+          EnvironmentVariables="NUGET_PACKAGES=$(SharedFrameworkIntermediatePackagesDir)" />
   </Target>
 
-</Project>
\ No newline at end of file
+</Project>
-- 
1.8.3.1

